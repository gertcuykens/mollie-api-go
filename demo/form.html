<dom-module id="my-form" attributes="items added cart">
    <template>
        <style>
            .item:hover{color:#38D3D8}

            #error:before {content:'* '}

            #error {
                width: 220px;
                text-align: justify;
                margin-top:10px;
            }

			p{margin:0; padding:0;}

            paper-input {width:220px;}

	        paper-fab {
	            color: #FFF;
	            background: #38D3D8;
				z-index:1;
	        }

            section {
                display: table;
                height: 100%;
                border-collapse: collapse;
            }

            .footer {
                display: table-row;
                height: 50px;
                vertical-align: bottom;
                width:220px;
            }

        </style>

        <core-localstorage name="webshop" value="{{cart}}" autoSaveDisabled></core-localstorage>

        <section style="margin-left:10px;">

            <div id="error">
                This is  the list of items you have
                selected. Click the item to remove it from your order.
            </div>

            <div id="order" style="margin:10px 0">

                <template repeat="{{i in keys}}">
                    <p style="margin-bottom:10px;" data-id="{{i}}" data-name="{{items[i].album}}" data-description="{{items[i].description}}" data-qty="{{cart[i]}}" data-price="{{items[i].price}}" class="item" on-tap="{{remove}}">
                        <span>- {{items[i].album}} <br/> {{items[i].description}}</span>
                        <span hidden?="{{cart[i]<2}}"> x{{cart[i]}}</span>
                    </p>
                </template>

            </div>

            <div class="footer">

                <paper-input-decorator label="Your email" error="required" isInvalid="{{!$.email.validity.valid}}">
                    <core-localstorage name="email" value="{{order.email}}"></core-localstorage>
                    <input id="email" name="email" value="{{order.email}}" is="core-input" type="email" required>
                </paper-input-decorator>

                <div layout horizontal end style="margin:10px 0 20px 0;">
                    <div flex layout vertical>
                        <core-label horizontal layout>
                            Shipping:
                            <paper-checkbox id="ship" checked for style="margin-left:5px"></paper-checkbox>
                        </core-label>
                        Total: {{total | ship(shipping)}}&#8364;
                    </div>
                    <paper-fab icon="shopping-cart" on-tap="{{submit}}"></paper-fab>
                </div>

            </div>

        </section>

    </template>

    <script>

        Polymer({
            is:'my-form',
            order:{},
            total:0,
            tax:0,
            shipping:6.95,
            keys:[],
            cart:{},

            ship: function() {
                return (+this.total+this.shipping).toFixed(2);
            },

            //cartChanged:function(){this.keys=Object.keys(this.cart)},
            cartChanged:function(){this.added = !this.added},

			addedChanged: function(){ //UGLY
                var t=0
                this.keys=Object.keys(this.cart)
                for (var i = 0; i < this.keys.length; ++i) { t += (this.cart[this.keys[i]] * this.items[this.keys[i]].price) }
                this.total=t.toFixed(2)
                //this.tax=(this.total * 0.21).toFixed(2)
                this.shadowRoot.querySelector('core-localstorage').save()
                //console.log(this.cart)
			},

            remove:function(e){
                var d = e.currentTarget.dataset
                d.qty = parseInt(d.qty)-1
                this.cart[d.id] = d.qty
                if (d.qty == 0) {delete this.cart[d.id]} //e.target.parentNode.removeChild(e.target)
				this.added = !this.added
            },

            submit:function(){
                var items=[]
                var p = this.shadowRoot.querySelectorAll('#order p')
                for (var i = 0; i < p.length; ++i) {
                    var d=p[i].dataset
                    if (d.qty>0) {
                        item = {
                            "name": d.name,
                            "description": d.description,
                            "quantity": d.qty,
                            "price": d.price,
                            "currency": "EUR"
                        }
                        items.push(item)
                    }
                }

                if (items.length == 0) {
                    this.$.error.innerHTML="No items selected."
                    return
                }

                if (!this.$.email.validity.valid) {
                    this.$.error.innerHTML="Please enter your email."
                    return
                }

                if (this.$.ship.checked) {
                    item = {
                        "name": "Shipping",
                        "description": "NL",
                        "quantity": "1",
                        "price": String(this.shipping),
                        "currency": "EUR"
                    }
                    items.push(item)
                }

                this.order.list = items

                this.$.error.innerHTML="Sending order..."

                var xhrOnload = function(e) {
                    if (e.target.status == 200) {
                        this.order.meta = e.target.response
                        this.mollie()
                    } else {
                        this.fab.icon="close"
                        this.fab.style.background='#d30000'
                        this.$.error.innerHTML="Server error"
                    }
                }.bind(this)

                var xhr = new XMLHttpRequest()
                xhr.responseType = "json"
                xhr.open("POST", "order.go", true)
                xhr.setRequestHeader("Content-Type", "application/json")
                xhr.onload = xhrOnload
                xhr.send(JSON.stringify(this.order))
            },

            mollie:function() {
                this.$.error.innerHTML="Waiting for mollie server..."

                var xhrOnload = function(e) {
                    if (e.target.status == 200) {
                        //this.$.error.innerHTML="Billing has been send to your email adress."
                        window.location = e.target.response.link
                    } else {
                        this.fab.icon="close"
                        this.fab.style.background='#d30000'
                        this.$.error.innerHTML="Server error"
                    }
                }.bind(this)

                body  ="amount="+(Number(this.total)+Number(this.shipping)).toFixed(2)
                body +="&description="+this.order.email
                body +="&redirectUrl="+location.origin+location.pathname+location.hash
                //body +="&webhookUrl="+location.origin+"/webhook.go"
                this.order.meta.forEach(function(i){
                    body +="&metadata["+i+"]="+this.order.email
                }.bind(this))

                var xhr = new XMLHttpRequest()
                xhr.responseType = "json"
                xhr.open("POST", "mollie.go", true)
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
                xhr.onload = xhrOnload
                xhr.send(body)
            },

            ready:function(){
				this.fab=this.shadowRoot.querySelector('paper-fab')

                this.$.ship.addEventListener("change", function(e){
                    this.shipping = 0
                    if (e.target.checked) this.shipping = 6.95
                }.bind(this))

            }

            /*if (location.search.substring(1)=="completed") {
                        this.fab.icon="done"
                        this.fab.style.background='#259b24'
                        this.$.error.innerHTML="We wil contact you as soon as possible. Thank you!"
                        this.submit=function() {
                            localStorage.clear()
                            window.location=""
                        }
            }*/

        })
    </script>
</dom-module>
